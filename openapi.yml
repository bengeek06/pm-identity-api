openapi: 3.0.3
info:
  title: Identity Service API
  version: 0.0.1
  description: |
    Identity Service is a comprehensive identity microservice
    designed for modern distributed architectures. It provides robust user and company management features.

    Key Features:
    - Company Management: Multi-tenant architecture with company-based data isolation
    - User Management: Full user lifecycle with profile management  
    - Organizational Structure: Hierarchical organization units and position management
    - Business Relationships: Customer and subcontractor management
    - Security & RBAC: JWT cookie authentication with Guardian Service (RBAC) and Authentification Service (token management) integration
    - Health Monitoring: Comprehensive health checks and monitoring endpoints
    - Database Management: Automated migrations and initialization workflows

  contact:
      name: Identity Service Support
      email: bengeek06@gmail.com
  license:
    name: AGPL v3 / Commercial
    url: https://github.com/bengeek06/pm-identity-api/blob/identity_staging/LICENSE.md

servers:
  - url: http://localhost:5002
    description: Staging development server
  - url: http://localhost:5000
    description: Local development server
  
security:
  - JWTAuth: []

components:
  securitySchemes:
    JWTAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token passed via HTTP-only cookies containing company_id and user_id. Validated by Identity Service; access control performed via Guardian Service /check-access endpoint.


  schemas:
    Customer:
      type: object
      required:
        - name
        - company_id
      properties:
        id:
          type: string
          readOnly: true
          description: Unique identifier of the customer
        name:
          type: string
          maxLength: 100
          description: Name of the customer
        company_id:
          type: string
          format: uuid
          readOnly: true
          description: Associated company identifier (auto-assigned from JWT)
        logo_file_id:
          type: string
          maxLength: 36
          readOnly: true
          description: File ID reference from Storage Service for customer logo
        has_logo:
          type: boolean
          readOnly: true
          description: Indicates if the customer has a logo uploaded
        email:
          type: string
          format: email
          maxLength: 100
          description: Email address of the customer
        contact_person:
          type: string
          maxLength: 100
          description: Contact person name
        phone_number:
          type: string
          maxLength: 50
          description: Phone number (digits only)
        address:
          type: string
          maxLength: 255
          description: Address of the customer
        created_at:
          type: string
          format: date-time
          readOnly: true
          description: Creation date
        updated_at:
          type: string
          format: date-time
          readOnly: true
          description: Last update date

    CustomerCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the customer
        email:
          type: string
          format: email
          maxLength: 100
          description: Email address of the customer
        contact_person:
          type: string
          maxLength: 100
          description: Contact person name
        phone_number:
          type: string
          maxLength: 50
          description: Phone number (digits only)
        address:
          type: string
          maxLength: 255
          description: Address of the customer

    CustomerUpdate:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the customer
        email:
          type: string
          format: email
          maxLength: 100
          description: Email address of the customer
        contact_person:
          type: string
          maxLength: 100
          description: Contact person name
        phone_number:
          type: string
          maxLength: 50
          description: Phone number (digits only)
        address:
          type: string
          maxLength: 255
          description: Address of the customer
    Subcontractor:
      type: object
      required:
        - name
        - company_id
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
          description: Unique identifier of the subcontractor
        name:
          type: string
          maxLength: 100
          description: Name of the subcontractor
        company_id:
          type: string
          format: uuid
          readOnly: true
          description: Associated company identifier (auto-assigned from JWT)
        logo_file_id:
          type: string
          maxLength: 36
          readOnly: true
          description: File ID reference from Storage Service for subcontractor logo
        has_logo:
          type: boolean
          readOnly: true
          description: Indicates if the subcontractor has a logo uploaded
        description:
          type: string
          maxLength: 255
          description: Optional description of the subcontractor
        contact_person:
          type: string
          maxLength: 100
          description: Optional contact person for the subcontractor
        phone_number:
          type: string
          maxLength: 50
          description: Phone number (digits only)
        email:
          type: string
          format: email
          maxLength: 100
          description: Email address of the subcontractor
        address:
          type: string
          maxLength: 255
          description: Address of the subcontractor
        created_at:
          type: string
          format: date-time
          readOnly: true
          description: Creation date
        updated_at:
          type: string
          format: date-time
          readOnly: true
          description: Last update date

    SubcontractorCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the subcontractor
        description:
          type: string
          maxLength: 255
          description: Optional description of the subcontractor
        contact_person:
          type: string
          maxLength: 100
          description: Optional contact person for the subcontractor
        phone_number:
          type: string
          maxLength: 50
          description: Phone number (digits only)
        email:
          type: string
          format: email
          maxLength: 100
          description: Email address of the subcontractor
        address:
          type: string
          maxLength: 255
          description: Address of the subcontractor

    SubcontractorUpdate:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the subcontractor
        description:
          type: string
          maxLength: 255
          description: Optional description of the subcontractor
        contact_person:
          type: string
          maxLength: 100
          description: Optional contact person for the subcontractor
        phone_number:
          type: string
          maxLength: 50
          description: Phone number (digits only)
        email:
          type: string
          format: email
          maxLength: 100
          description: Email address of the subcontractor
        address:
          type: string
          maxLength: 255
          description: Address of the subcontractor
    Position:
      type: object
      required:
        - title
        - company_id
        - organization_unit_id
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
          description: Unique identifier of the position
        title:
          type: string
          maxLength: 100
          description: Title or name of the position
        description:
          type: string
          maxLength: 255
          description: Optional description of the position
        company_id:
          type: string
          format: uuid
          readOnly: true
          description: Associated company identifier (auto-assigned from JWT)
        organization_unit_id:
          type: string
          format: uuid
          description: Associated organization unit identifier
        level:
          type: integer
          description: Level or rank of the position (must be >= 0)
          minimum: 0
        created_at:
          type: string
          format: date-time
          readOnly: true
          description: Creation date
        updated_at:
          type: string
          format: date-time
          readOnly: true
          description: Last update date

    PositionCreate:
      type: object
      required:
        - title
        - organization_unit_id
      properties:
        title:
          type: string
          maxLength: 100
          description: Title or name of the position
        description:
          type: string
          maxLength: 255
          description: Optional description of the position
        organization_unit_id:
          type: string
          format: uuid
          description: Organization unit identifier the position belongs to
        level:
          type: integer
          minimum: 0
          description: Level or rank of the position (must be >= 0)

    PositionCreateInUnit:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          maxLength: 100
          description: Title or name of the position
        description:
          type: string
          maxLength: 255
          description: Optional description of the position
        level:
          type: integer
          minimum: 0
          description: Level or rank of the position (must be >= 0)

    PositionUpdate:
      type: object
      properties:
        title:
          type: string
          maxLength: 100
          description: Title or name of the position
        description:
          type: string
          maxLength: 255
          description: Optional description of the position
        organization_unit_id:
          type: string
          format: uuid
          description: Organization unit identifier the position belongs to
        level:
          type: integer
          minimum: 0
          description: Level or rank of the position (must be >= 0)
    OrganizationUnit:
      type: object
      required:
        - name
        - company_id
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
          description: Unique identifier of the organization unit
        name:
          type: string
          maxLength: 100
          description: Name of the organization unit
        company_id:
          type: string
          format: uuid
          readOnly: true
          description: Associated company identifier (auto-assigned from JWT)
        description:
          type: string
          maxLength: 255
          description: Optional description of the organization unit
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Optional parent organization unit identifier
        path:
          type: string
          readOnly: true
          description: Hierarchical path of the organization unit
        level:
          type: integer
          readOnly: true
          description: Hierarchy level of the organization unit
        created_at:
          type: string
          format: date-time
          readOnly: true
          description: Creation date
        updated_at:
          type: string
          format: date-time
          readOnly: true
          description: Last update date

    OrganizationUnitCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the organization unit
        description:
          type: string
          maxLength: 255
          description: Optional description of the organization unit
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Optional parent organization unit identifier

    OrganizationUnitUpdate:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the organization unit
        description:
          type: string
          maxLength: 255
          description: Optional description of the organization unit
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Optional parent organization unit identifier
    Company:
      type: object
      required:
        - name
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
          description: Unique identifier of the company
        name:
          type: string
          maxLength: 100
          description: Name of the company
        description:
          type: string
          maxLength: 255
          description: Optional description of the company
        logo_file_id:
          type: string
          maxLength: 36
          readOnly: true
          description: File ID reference from Storage Service for company logo
        has_logo:
          type: boolean
          readOnly: true
          description: Indicates if the company has a logo uploaded
        website:
          type: string
          format: uri
          maxLength: 255
          description: Website URL of the company
        phone_number:
          type: string
          maxLength: 20
          description: Phone number of the company (digits only)
        email:
          type: string
          format: email
          maxLength: 255
          description: Email address of the company
        address:
          type: string
          maxLength: 255
          description: Address of the company
        postal_code:
          type: string
          maxLength: 20
          description: Postal code of the company
        city:
          type: string
          maxLength: 100
          description: City where the company is located
        country:
          type: string
          maxLength: 100
          description: Country where the company is located
        created_at:
          type: string
          format: date-time
          readOnly: true
          description: Creation date
        updated_at:
          type: string
          format: date-time
          readOnly: true
          description: Last update date

    CompanyCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the company
        description:
          type: string
          maxLength: 255
          description: Optional description of the company
        website:
          type: string
          format: uri
          maxLength: 255
          description: Website URL of the company
        phone_number:
          type: string
          maxLength: 20
          description: Phone number of the company (digits only)
        email:
          type: string
          format: email
          maxLength: 255
          description: Email address of the company
        address:
          type: string
          maxLength: 255
          description: Address of the company
        postal_code:
          type: string
          maxLength: 20
          description: Postal code of the company
        city:
          type: string
          maxLength: 100
          description: City where the company is located
        country:
          type: string
          maxLength: 100
          description: Country where the company is located

    CompanyUpdate:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
          description: Name of the company
        description:
          type: string
          maxLength: 255
          description: Optional description of the company
        website:
          type: string
          format: uri
          maxLength: 255
          description: Website URL of the company
        phone_number:
          type: string
          maxLength: 20
          description: Phone number of the company (digits only)
        email:
          type: string
          format: email
          maxLength: 255
          description: Email address of the company
        address:
          type: string
          maxLength: 255
          description: Address of the company
        postal_code:
          type: string
          maxLength: 20
          description: Postal code of the company
        city:
          type: string
          maxLength: 100
          description: City where the company is located
        country:
          type: string
          maxLength: 100
          description: Country where the company is located
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          description: Error message
        errors:
          type: object
          description: Detailed validation errors
          additionalProperties: true
      required:
        - message
    
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        service:
          type: string
          example: identity_service
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: "1.0.0"
        environment:
          type: string
          enum: [development, testing, staging, production]
        checks:
          type: object
          properties:
            database:
              type: object
              properties:
                healthy:
                  type: boolean
                message:
                  type: string
                response_time_ms:
                  type: number
                  format: float

    VersionResponse:
      type: object
      properties:
        version:
          type: string
          example: "1.0.0"
      required:
        - version

    ConfigResponse:
      type: object
      properties:
        env:
          type: string
          enum: [development, testing, staging, production]
        debug:
          type: boolean
        database_url:
          type: string
          description: Database connection URL (sensitive info masked)

    InitDbResponse:
      type: object
      properties:
        initialized:
          type: boolean
          description: Whether the database has been initialized
        message:
          type: string

    User:
      type: object
      required:
        - email
        - company_id
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
          description: Unique identifier of the user
        email:
          type: string
          format: email
          maxLength: 100
          description: User's email address
        hashed_password:
          type: string
          maxLength: 255
          writeOnly: true
          description: Hashed password
        first_name:
          type: string
          maxLength: 50
          description: User's first name
        last_name:
          type: string
          maxLength: 50
          description: User's last name
        phone_number:
          type: string
          maxLength: 50
          description: Phone number
        avatar_file_id:
          type: string
          format: uuid
          readOnly: true
          description: Storage Service file_id reference for user avatar
        has_avatar:
          type: boolean
          default: false
          readOnly: true
          description: Whether the user has an avatar uploaded
        is_active:
          type: boolean
          default: true
          description: Indicates if the user account is active
        is_verified:
          type: boolean
          default: false
          description: Indicates if the email is verified
        last_login_at:
          type: string
          format: date-time
          description: Last login date
        company_id:
          type: string
          format: uuid
          readOnly: true
          description: Associated company identifier (auto-assigned from JWT)
        position_id:
          type: string
          format: uuid
          description: Associated position identifier
        created_at:
          type: string
          format: date-time
          readOnly: true
          description: Creation date
        updated_at:
          type: string
          format: date-time
          readOnly: true
          description: Last update date
        language:
          type: string
          enum: [en, fr]
          description: User language (en, fr)
        password_reset_required:
          type: boolean
          default: false
          readOnly: true
          description: Indicates if user must change password on next login
        last_password_change:
          type: string
          format: date-time
          readOnly: true
          description: Timestamp of last password change

    UserCreate:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          maxLength: 100
          description: User's email address
        password:
          type: string
          description: Plain password (will be hashed automatically)
        first_name:
          type: string
          maxLength: 50
          description: User's first name
        last_name:
          type: string
          maxLength: 50
          description: User's last name
        phone_number:
          type: string
          maxLength: 50
          description: Phone number
        is_active:
          type: boolean
          default: true
          description: Indicates if the user account is active
        is_verified:
          type: boolean
          default: false
          description: Indicates if the email is verified
        position_id:
          type: string
          format: uuid
          description: Associated position identifier
        language:
          type: string
          enum: [en, fr]
          description: User language (en, fr)

    UserUpdate:
      type: object
      properties:
        email:
          type: string
          format: email
          maxLength: 100
          description: User's email address
        password:
          type: string
          description: New plain password (will be hashed automatically)
        first_name:
          type: string
          maxLength: 50
          description: User's first name
        last_name:
          type: string
          maxLength: 50
          description: User's last name
        phone_number:
          type: string
          maxLength: 50
          description: Phone number
        avatar_file_id:
          type: string
          format: uuid
          readOnly: true
          description: Storage Service file_id reference for user avatar
        has_avatar:
          type: boolean
          readOnly: true
          default: false
          description: Whether the user has an avatar uploaded
        is_active:
          type: boolean
          description: Indicates if the user account is active
        is_verified:
          type: boolean
          description: Indicates if the email is verified
        position_id:
          type: string
          format: uuid
          description: Associated position identifier
        language:
          type: string
          enum: [en, fr]
          description: User language (en, fr)

    Role:
      type: object
      description: Role object enriched with details from Guardian Service
      properties:
        id:
          type: string
          description: Unique identifier of the role (from Guardian Service)
        name:
          type: string
          description: Name of the role
        description:
          type: string
          nullable: true
          description: Optional description of the role
        company_id:
          type: string
          format: uuid
          nullable: true
          description: Company identifier for multi-tenant isolation (null for global roles)
        created_at:
          type: string
          format: date-time
          description: Timestamp when the role was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the role was last updated

    UserRole:
      type: object
      description: |
        Enriched UserRole object combining junction table metadata with full role details.
        
        As of Issue #73, this schema now includes the nested 'role' object with complete
        role information from Guardian Service, enabling proper display and deletion operations.
      properties:
        id:
          type: string
          description: Unique identifier of the user role junction (use this for DELETE operations)
          example: "ur-12345"
        user_id:
          type: string
          format: uuid
          description: User identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        role_id:
          type: string
          description: Role identifier (from Guardian Service)
          example: "role-001"
        created_at:
          type: string
          format: date-time
          description: When the role was assigned to the user
          example: "2025-01-15T10:30:00Z"
        role:
          type: object
          description: Full role details from Guardian Service
          properties:
            id:
              type: string
              description: Role identifier
              example: "role-001"
            name:
              type: string
              description: Role name
              example: "Administrator"
            description:
              type: string
              nullable: true
              description: Role description
              example: "Full system access"
            company_id:
              type: string
              format: uuid
              description: Company identifier for multi-tenant isolation
              example: "987fcdeb-51a2-43d1-9f12-345678901234"
            created_at:
              type: string
              format: date-time
              description: When the role was created
              example: "2025-01-10T08:00:00Z"
            updated_at:
              type: string
              format: date-time
              description: When the role was last updated
              example: "2025-01-10T08:00:00Z"

    UserRoleAssignment:
      type: object
      required:
        - role_id
      properties:
        role_id:
          type: string
          description: Role identifier to assign (from Guardian Service)

    Policy:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier of the policy
        name:
          type: string
          description: Name of the policy
        description:
          type: string
          nullable: true
          description: Optional description of the policy
        company_id:
          type: string
          format: uuid
          description: Company identifier for multi-tenant isolation
        created_at:
          type: string
          format: date-time
          description: Timestamp when the policy was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the policy was last updated

    Permission:
      type: object
      required:
        - id
        - service
        - resource_name
        - operation
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier of the permission
        service:
          type: string
          description: Service name this permission belongs to
        resource_name:
          type: string
          description: Name of the resource this permission applies to
        description:
          type: string
          nullable: true
          description: Optional description of the permission
        operation:
          type: string
          enum: [LIST, CREATE, READ, UPDATE, DELETE]
          description: Operation allowed by this permission (SINGULAR UPPERCASE as per Guardian spec)
        company_id:
          type: string
          format: uuid
          nullable: true
          description: Company identifier for multi-tenant isolation
        created_at:
          type: string
          format: date-time
          description: Timestamp when the permission was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the permission was last updated

    PasswordVerification:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
        password:
          type: string
          description: Password to verify

    PaginationMetadata:
      type: object
      properties:
        page:
          type: integer
          description: Current page number
          example: 1
        limit:
          type: integer
          description: Number of items per page
          example: 50
        total:
          type: integer
          description: Total number of items
          example: 150
        pages:
          type: integer
          description: Total number of pages
          example: 3
        has_next:
          type: boolean
          description: Whether there is a next page
          example: true
        has_prev:
          type: boolean
          description: Whether there is a previous page
          example: false

  responses:
    CustomerCreated:
      description: Customer created successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Customer'

    CustomerList:
      description: Paginated list of customers
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: '#/components/schemas/Customer'
              pagination:
                $ref: '#/components/schemas/PaginationMetadata'

    CustomerDetails:
      description: Customer details
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Customer'

    CustomerUpdated:
      description: Customer updated successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Customer'

    CustomerDeleted:
      description: Customer deleted successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Customer deleted successfully"
    PositionCreated:
      description: Position created successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Position'

    PositionList:
      description: Paginated list of positions
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: '#/components/schemas/Position'
              pagination:
                $ref: '#/components/schemas/PaginationMetadata'

    PositionDetails:
      description: Position details
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Position'

    PositionUpdated:
      description: Position updated successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Position'

    PositionDeleted:
      description: Position deleted successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Position deleted successfully"
    OrganizationUnitCreated:
      description: Organization unit created successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/OrganizationUnit'

    OrganizationUnitList:
      description: Paginated list of organization units
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: '#/components/schemas/OrganizationUnit'
              pagination:
                $ref: '#/components/schemas/PaginationMetadata'

    OrganizationUnitDetails:
      description: Organization unit details
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/OrganizationUnit'

    OrganizationUnitUpdated:
      description: Organization unit updated successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/OrganizationUnit'

    OrganizationUnitDeleted:
      description: Organization unit deleted successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Organization unit deleted successfully"
    CompanyCreated:
      description: Company created successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Company'

    CompanyList:
      description: Paginated list of companies
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: '#/components/schemas/Company'
              pagination:
                $ref: '#/components/schemas/PaginationMetadata'

    CompanyDetails:
      description: Company details
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Company'

    CompanyUpdated:
      description: Company updated successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Company'

    CompanyDeleted:
      description: Company deleted successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Company deleted successfully"
    Unauthorized:
      description: Missing, invalid, or expired JWT token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Missing or invalid JWT token"

    BadRequest:
      description: Invalid request data or malformed UUIDs
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Invalid input data"

    NotFound:
      description: Resource not found within company context
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Resource not found"

    Conflict:
      description: Resource already exists or constraint violation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Resource already exists"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Internal server error"

    Forbidden:
      description: Valid authentication but insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Access denied - insufficient permissions"

    SubcontractorCreated:
      description: Subcontractor created successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Subcontractor'

    SubcontractorList:
      description: Paginated list of subcontractors
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: '#/components/schemas/Subcontractor'
              pagination:
                $ref: '#/components/schemas/PaginationMetadata'

    SubcontractorDetails:
      description: Subcontractor details
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Subcontractor'

    SubcontractorUpdated:
      description: Subcontractor updated successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Subcontractor'

    SubcontractorDeleted:
      description: Subcontractor deleted successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Subcontractor deleted successfully"

    UserCreated:
      description: User created successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/User'

    UserList:
      description: Paginated list of users
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: '#/components/schemas/User'
              pagination:
                $ref: '#/components/schemas/PaginationMetadata'

    UserDetails:
      description: User details
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/User'

    UserUpdated:
      description: User updated successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/User'

    UserDeleted:
      description: User deleted successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "User deleted successfully"

    UserRoles:
      description: |
        User roles list with enriched role objects.
        
        As of Issue #73, this endpoint returns enriched UserRole objects that include:
        - Junction metadata (id, user_id, role_id, created_at) for proper DELETE operations
        - Nested role details (name, description) from Guardian Service for display
        
        This structure allows the frontend to:
        1. Display role names using role.name
        2. Delete roles correctly using the junction id
      content:
        application/json:
          schema:
            type: object
            properties:
              roles:
                type: array
                items:
                  $ref: '#/components/schemas/UserRole'
          example:
            roles:
              - id: "ur-001"
                user_id: "550e8400-e29b-41d4-a716-446655440000"
                role_id: "role-001"
                created_at: "2024-01-15T10:30:00Z"
                role:
                  id: "role-001"
                  name: "companyadmin"
                  description: "Company administrator with full access to company resources"
                  company_id: "987fcdeb-51a2-43d1-9f12-345678901234"
                  created_at: "2024-01-15T10:30:00Z"
                  updated_at: "2024-01-15T10:30:00Z"
              - id: "ur-002"
                user_id: "550e8400-e29b-41d4-a716-446655440000"
                role_id: "role-002"
                created_at: "2024-02-10T14:20:00Z"
                role:
                  id: "role-002"
                  name: "projectmanager"
                  description: "Project manager with access to project management features"
                  company_id: "987fcdeb-51a2-43d1-9f12-345678901234"
                  created_at: "2024-02-10T14:20:00Z"
                  updated_at: "2024-02-10T14:20:00Z"

    UserRoleCreated:
      description: Role assigned to user successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/UserRole'

    PasswordVerificationResult:
      description: Password verification result
      content:
        application/json:
          schema:
            type: object
            properties:
              valid:
                type: boolean
                description: Indicates if the password is valid
              user:
                $ref: '#/components/schemas/User'
   
paths:
  /customers:
    get:
      tags: [Customers Management]
      summary: List all customers
      description: Returns the list of all customers with optional filtering, search, pagination, and sorting
      parameters:
        - name: id__in
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated list of UUIDs to filter by. Returns only customers with matching IDs. Empty string returns empty list.
          example: "550e8400-e29b-41d4-a716-446655440000,660e8400-e29b-41d4-a716-446655440001"
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Filter by exact customer name match
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Search in name, email, and contact_person (case-insensitive)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Number of items per page (max 1000)
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, updated_at, name]
            default: created_at
          description: Field to sort by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
      responses:
        '200':
          $ref: '#/components/responses/CustomerList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Customers Management]
      summary: Create a new customer
      description: |
        Creates a new customer with the provided data.
        The company_id is automatically extracted from the JWT token and cannot be provided in the request body.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CustomerCreate'
      responses:
        '201':
          $ref: '#/components/responses/CustomerCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /customers/{customer_id}:
    parameters:
      - name: customer_id
        in: path
        required: true
        schema:
          type: string
        description: Unique identifier of the customer

    get:
      tags: [Customers Management]
      summary: Get a customer by ID
      description: Returns details of a specific customer
      responses:
        '200':
          $ref: '#/components/responses/CustomerDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Customers Management]
      summary: Update a customer
      description: Fully updates an existing customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CustomerUpdate'
      responses:
        '200':
          $ref: '#/components/responses/CustomerUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Customers Management]
      summary: Partially update a customer
      description: Partially updates an existing customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CustomerUpdate'
      responses:
        '200':
          $ref: '#/components/responses/CustomerUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Customers Management]
      summary: Delete a customer
      description: Deletes an existing customer
      responses:
        '204':
          $ref: '#/components/responses/CustomerDeleted'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /customers/{customer_id}/logo:
    parameters:
      - name: customer_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the customer

    post:
      tags: [Customers Management]
      summary: Upload customer logo
      description: Upload a logo image for the customer. The logo is stored in the Storage Service and a file_id reference is saved.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - logo
              properties:
                logo:
                  type: string
                  format: binary
                  description: Logo image file (PNG, JPG, JPEG)
      responses:
        '201':
          description: Logo uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logo uploaded successfully
                  logo_file_id:
                    type: string
                    example: 550e8400-e29b-41d4-a716-446655440000
                  has_logo:
                    type: boolean
                    example: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Cannot manage other company's customer logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
        '503':
          description: Service Unavailable - Storage Service disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Customers Management]
      summary: Get customer logo
      description: Retrieve the customer logo image from Storage Service
      responses:
        '200':
          description: Logo image
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Customer not found or has no logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Customers Management]
      summary: Delete customer logo
      description: Remove the customer logo from Storage Service and clear the reference
      responses:
        '204':
          description: Logo deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Cannot delete other company's customer logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Customer not found or has no logo to delete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /positions:
    get:
      tags: [Positions]
      summary: List all positions
      description: Returns the list of all positions with optional filtering, search, pagination, and sorting
      parameters:
        - name: id__in
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated list of UUIDs to filter by. Returns only positions with matching IDs. Empty string returns empty list.
          example: "550e8400-e29b-41d4-a716-446655440000,660e8400-e29b-41d4-a716-446655440001"
        - name: title
          in: query
          required: false
          schema:
            type: string
          description: Filter by exact position title match
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Search in title and description (case-insensitive)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Number of items per page (max 1000)
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, updated_at, title]
            default: created_at
          description: Field to sort by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
      responses:
        '200':
          $ref: '#/components/responses/PositionList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Positions]
      summary: Create a new position
      description: |
        Creates a new position with the provided data.
        The company_id is automatically extracted from the JWT token and validated against the organization unit's company.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PositionCreate'
      responses:
        '201':
          $ref: '#/components/responses/PositionCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /positions/{position_id}:
    parameters:
      - name: position_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the position

    get:
      tags: [Positions]
      summary: Get a position by ID
      description: Returns details of a specific position
      responses:
        '200':
          $ref: '#/components/responses/PositionDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Positions]
      summary: Update a position
      description: Fully updates an existing position
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PositionUpdate'
      responses:
        '200':
          $ref: '#/components/responses/PositionUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Positions]
      summary: Partially update a position
      description: Partially updates an existing position
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PositionUpdate'
      responses:
        '200':
          $ref: '#/components/responses/PositionUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Positions]
      summary: Delete a position
      description: Deletes an existing position
      responses:
        '204':
          $ref: '#/components/responses/PositionDeleted'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /organization_units/{unit_id}/positions:
    parameters:
      - name: unit_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the organization unit

    get:
      tags: [Positions]
      summary: List positions for an organization unit
      description: Returns the list of positions associated with a specific organization unit
      responses:
        '200':
          $ref: '#/components/responses/PositionList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Positions]
      summary: Create a position for an organization unit
      description: |
        Creates a new position within the specified organization unit.
        The company_id is automatically extracted from the JWT token and validated against the organization unit's company.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PositionCreateInUnit'
      responses:
        '201':
          $ref: '#/components/responses/PositionCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /organization_units:
    get:
      tags: [Organizations]
      summary: List all organization units
      description: Returns the list of all organization units with optional filtering, search, pagination, and sorting
      parameters:
        - name: id__in
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated list of UUIDs to filter by. Returns only organization units with matching IDs. Empty string returns empty list.
          example: "550e8400-e29b-41d4-a716-446655440000,660e8400-e29b-41d4-a716-446655440001"
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Filter by exact organization unit name match
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Search in name and description (case-insensitive)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Number of items per page (max 1000)
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, updated_at, name, level]
            default: created_at
          description: Field to sort by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
      responses:
        '200':
          $ref: '#/components/responses/OrganizationUnitList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Organizations]
      summary: Create a new organization unit
      description: |
        Creates a new organization unit with the provided data.
        The company_id is automatically extracted from the JWT token and cannot be provided in the request body.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationUnitCreate'
      responses:
        '201':
          $ref: '#/components/responses/OrganizationUnitCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /organization_units/{unit_id}:
    parameters:
      - name: unit_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the organization unit

    get:
      tags: [Organizations]
      summary: Get an organization unit by ID
      description: Returns details of a specific organization unit
      responses:
        '200':
          $ref: '#/components/responses/OrganizationUnitDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Organizations]
      summary: Update an organization unit
      description: Fully updates an existing organization unit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationUnitUpdate'
      responses:
        '200':
          $ref: '#/components/responses/OrganizationUnitUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Organizations]
      summary: Partially update an organization unit
      description: Partially updates an existing organization unit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationUnitUpdate'
      responses:
        '200':
          $ref: '#/components/responses/OrganizationUnitUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Organizations]
      summary: Delete an organization unit
      description: Deletes an existing organization unit
      responses:
        '204':
          $ref: '#/components/responses/OrganizationUnitDeleted'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /organization_units/{unit_id}/children:
    parameters:
      - name: unit_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the organization unit

    get:
      tags: [Organizations]
      summary: List children of an organization unit
      description: Returns the list of child organization units for the given parent organization unit
      responses:
        '200':
          $ref: '#/components/responses/OrganizationUnitList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /companies:
    get:
      tags: [Companies]
      summary: List all companies
      description: Returns the list of all companies with optional filtering, search, pagination, and sorting
      parameters:
        - name: id__in
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated list of UUIDs to filter by. Returns only companies with matching IDs. Empty string returns empty list.
          example: "550e8400-e29b-41d4-a716-446655440000,660e8400-e29b-41d4-a716-446655440001"
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Filter by exact company name match
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Search in name and description (case-insensitive)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Number of items per page (max 1000)
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, updated_at, name]
            default: created_at
          description: Field to sort by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
      responses:
        '200':
          $ref: '#/components/responses/CompanyList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Companies]
      summary: Create a new company
      description: Creates a new company with the provided data
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompanyCreate'
      responses:
        '201':
          $ref: '#/components/responses/CompanyCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /companies/{company_id}:
    parameters:
      - name: company_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the company

    get:
      tags: [Companies]
      summary: Get a company by ID
      description: Returns details of a specific company
      responses:
        '200':
          $ref: '#/components/responses/CompanyDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Companies]
      summary: Update a company
      description: Fully updates an existing company
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompanyUpdate'
      responses:
        '200':
          $ref: '#/components/responses/CompanyUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Companies]
      summary: Partially update a company
      description: Partially updates an existing company
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompanyUpdate'
      responses:
        '200':
          $ref: '#/components/responses/CompanyUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Companies]
      summary: Delete a company
      description: Deletes an existing company
      responses:
        '204':
          $ref: '#/components/responses/CompanyDeleted'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /companies/{company_id}/logo:
    parameters:
      - name: company_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the company

    post:
      tags: [Companies]
      summary: Upload company logo
      description: Upload a logo image for the company. The logo is stored in the Storage Service and a file_id reference is saved.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - logo
              properties:
                logo:
                  type: string
                  format: binary
                  description: Logo image file (PNG, JPG, JPEG)
      responses:
        '201':
          description: Logo uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logo uploaded successfully
                  logo_file_id:
                    type: string
                    example: 550e8400-e29b-41d4-a716-446655440000
                  has_logo:
                    type: boolean
                    example: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Cannot manage other company's logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
        '503':
          description: Service Unavailable - Storage Service disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Companies]
      summary: Get company logo
      description: Retrieve the company logo image from Storage Service
      responses:
        '200':
          description: Logo image
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Company not found or has no logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Companies]
      summary: Delete company logo
      description: Remove the company logo from Storage Service and clear the reference
      responses:
        '204':
          description: Logo deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Cannot delete other company's logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Company not found or has no logo to delete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /health:
    get:
      tags: [System]
      summary: Health check endpoint
      description: Returns comprehensive health information including database connectivity
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /version:
    get:
      tags: [System]
      summary: Get API version
      description: Returns the current version of the identity Service API
      responses:
        '200':
          description: API version information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /config:
    get:
      tags: [System]
      summary: Get application configuration
      description: Returns current application configuration (non-sensitive data only)
      responses:
        '200':
          description: Application configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /init-db:
    get:
      tags: [System]
      summary: Check database initialization status
      description: Returns whether the identity Service has been initialized
      security: []
      responses:
        '200':
          description: Initialization status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitDbResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [System]
      summary: Initialize database with company and admin user
      description: |
        Initialize the database with a company, default organization unit, default position, and admin user.
        
        This endpoint is intended to be called only once on a fresh database.
        It creates all entities atomically in a single transaction:
        1. Company (from request body)
        2. Default organization unit (auto-created with name "default organization")
        3. Default position (auto-created with title "Administrator")
        4. Admin user (from request body, linked to the position)
        
        The endpoint will return 403 if the database is already initialized (contains any company or user).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - company
                - user
              properties:
                company:
                  $ref: '#/components/schemas/CompanyCreate'
                user:
                  allOf:
                    - $ref: '#/components/schemas/UserCreate'
                    - type: object
                      required:
                        - password
                      properties:
                        password:
                          type: string
                          description: Plain password (will be hashed automatically)
                          minLength: 8
            example:
              company:
                name: "ACME Corporation"
                email: "contact@acme.com"
                phone_number: "1234567890"
                address: "123 Main Street"
                city: "New York"
                postal_code: "10001"
                country: "USA"
              user:
                email: "admin@acme.com"
                password: "SecurePassword123!"
                first_name: "John"
                last_name: "Doe"
                is_active: true
                is_verified: true
      responses:
        '201':
          description: Database initialized successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  company:
                    $ref: '#/components/schemas/Company'
                  organization_unit:
                    $ref: '#/components/schemas/OrganizationUnit'
                  position:
                    $ref: '#/components/schemas/Position'
                  user:
                    $ref: '#/components/schemas/User'
              example:
                company:
                  id: "550e8400-e29b-41d4-a716-446655440000"
                  name: "ACME Corporation"
                  email: "contact@acme.com"
                  phone_number: "1234567890"
                  address: "123 Main Street"
                  city: "New York"
                  postal_code: "10001"
                  country: "USA"
                  has_logo: false
                  created_at: "2024-01-15T10:30:00Z"
                  updated_at: "2024-01-15T10:30:00Z"
                organization_unit:
                  id: "660e8400-e29b-41d4-a716-446655440001"
                  name: "default organization"
                  company_id: "550e8400-e29b-41d4-a716-446655440000"
                  path: "/default organization"
                  level: 0
                  created_at: "2024-01-15T10:30:00Z"
                  updated_at: "2024-01-15T10:30:00Z"
                position:
                  id: "770e8400-e29b-41d4-a716-446655440002"
                  title: "Administrator"
                  company_id: "550e8400-e29b-41d4-a716-446655440000"
                  organization_unit_id: "660e8400-e29b-41d4-a716-446655440001"
                  level: 0
                  created_at: "2024-01-15T10:30:00Z"
                  updated_at: "2024-01-15T10:30:00Z"
                user:
                  id: "880e8400-e29b-41d4-a716-446655440003"
                  email: "admin@acme.com"
                  first_name: "John"
                  last_name: "Doe"
                  company_id: "550e8400-e29b-41d4-a716-446655440000"
                  position_id: "770e8400-e29b-41d4-a716-446655440002"
                  is_active: true
                  is_verified: true
                  has_avatar: false
                  created_at: "2024-01-15T10:30:00Z"
                  updated_at: "2024-01-15T10:30:00Z"
        '400':
          description: Validation error or invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing_fields:
                  value:
                    message: "'company' and 'user' data are required."
                validation_error:
                  value:
                    message: "Validation error"
                    errors:
                      password: ["Missing data for required field."]
        '403':
          description: Database already initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "Identity already initialized"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users:
    get:
      tags: [Users]
      summary: List all users
      description: Returns the list of all users for the authenticated company with optional filtering, search, pagination, sorting, and expansion of related entities
      parameters:
        - name: id__in
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated list of UUIDs to filter by. Returns only users with matching IDs. Empty string returns empty list.
          example: "550e8400-e29b-41d4-a716-446655440000,660e8400-e29b-41d4-a716-446655440001"
        - name: email
          in: query
          required: false
          schema:
            type: string
            format: email
          description: Filter by exact email match
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Search in email, first_name, and last_name (case-insensitive)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Number of items per page (max 1000)
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, updated_at, email]
            default: created_at
          description: Field to sort by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
        - name: expand
          in: query
          required: false
          schema:
            type: string
          description: |
            Comma-separated list of related entities to include inline in the response.
            Supported values: `position`.
            Unknown values are silently ignored.
          example: "position"
      responses:
        '200':
          $ref: '#/components/responses/UserList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Users]
      summary: Create a new user
      description: |
        Creates a new user with the provided data.
        The company_id is automatically extracted from the JWT token and cannot be provided in the request body.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '201':
          $ref: '#/components/responses/UserCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{user_id}:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the user

    get:
      tags: [Users]
      summary: Get a user by ID
      description: Returns details of a specific user with optional expansion of related entities
      parameters:
        - name: expand
          in: query
          required: false
          schema:
            type: string
          description: |
            Comma-separated list of related entities to include inline in the response.
            Supported values: `position`.
            Unknown values are silently ignored.
          example: "position"
      responses:
        '200':
          $ref: '#/components/responses/UserDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Users]
      summary: Update a user
      description: Fully updates an existing user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          $ref: '#/components/responses/UserUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Users]
      summary: Partially update a user
      description: Partially updates an existing user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          $ref: '#/components/responses/UserUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Users]
      summary: Delete a user
      description: Deletes an existing user
      responses:
        '204':
          $ref: '#/components/responses/UserDeleted'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{user_id}/roles:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the user

    get:
      tags: [Users]
      summary: Get user roles (enriched)
      description: |
        Returns the list of roles assigned to a user via the Guardian Service (RBAC).
        
        **Enrichment (Issue #64):**
        As of Issue #64, this endpoint returns full Role objects instead of junction table records.
        Each role includes:
        - id: Role identifier
        - name: Role name
        - description: Role description
        - company_id: Company identifier for multi-tenant isolation
        - created_at, updated_at: Timestamps
        
        The enrichment is performed by fetching role details from Guardian Service
        for each role_id in the user-role associations.
      responses:
        '200':
          $ref: '#/components/responses/UserRoles'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Users]
      summary: Assign a role to a user
      description: Assigns a new role to a user via the Guardian Service (RBAC)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRoleAssignment'
      responses:
        '201':
          $ref: '#/components/responses/UserRoleCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{user_id}/roles/{user_role_id}:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the user
      - name: user_role_id
        in: path
        required: true
        schema:
          type: string
        description: Unique identifier of the user role

    get:
      tags: [Users]
      summary: Get a specific user role
      description: Returns details of a role assigned to a user
      responses:
        '200':
          description: User role details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserRole'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Users]
      summary: Remove a role from a user
      description: Removes a specific role from a user via the Guardian Service (RBAC)
      responses:
        '204':
          description: Role removed successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{user_id}/policies:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the user

    get:
      tags: [Users]
      summary: Get user policies
      description: |
        Returns all policies associated with a user's roles via the Guardian Service (RBAC).
        
        This endpoint:
        1. Fetches all roles assigned to the user from Guardian
        2. For each role, fetches associated policies from Guardian
        3. Returns a deduplicated list of all policies
        
        The policies are aggregated from all roles and deduplicated by policy ID.
      responses:
        '200':
          description: List of policies for the user
          content:
            application/json:
              schema:
                type: object
                properties:
                  policies:
                    type: array
                    items:
                      $ref: '#/components/schemas/Policy'
              example:
                policies:
                  - id: "123e4567-e89b-12d3-a456-426614174000"
                    name: "Project Management Policy"
                    description: "Permissions for project management operations"
                    company_id: "987fcdeb-51a2-43d1-9f12-345678901234"
                  - id: "456e7890-f12b-34c5-d678-90abcdef1234"
                    name: "User Management Policy"
                    description: "Permissions for user management operations"
                    company_id: "987fcdeb-51a2-43d1-9f12-345678901234"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{user_id}/permissions:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the user

    get:
      tags: [Users]
      summary: Get user permissions
      description: |
        Returns all permissions associated with a user's policies via the Guardian Service (RBAC).
        
        This endpoint:
        1. Fetches all roles assigned to the user from Guardian
        2. For each role, fetches associated policies from Guardian
        3. For each policy, fetches associated permissions from Guardian
        4. Returns a deduplicated list of all permissions
        
        The permissions are aggregated from all policies of all roles and deduplicated by permission ID.
      responses:
        '200':
          description: List of permissions for the user
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'
              example:
                permissions:
                  - id: "123e4567-e89b-12d3-a456-426614174000"
                    service: "identity"
                    resource_name: "user"
                    description: "Manage users"
                    operations: ["create", "read", "update", "delete"]
                  - id: "456e7890-f12b-34c5-d678-90abcdef1234"
                    service: "identity"
                    resource_name: "company"
                    description: "Manage companies"
                    operations: ["read", "update"]
                  - id: "789abcde-f34c-56d7-e890-123456789012"
                    service: "guardian"
                    resource_name: "role"
                    description: "Manage roles"
                    operations: ["create", "read", "update", "delete"]
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{user_id}/admin-reset-password:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the user whose password to reset

    post:
      tags: [Users]
      summary: Admin-initiated password reset
      description: |
        Admin-initiated password reset (Issue #12 Phase 1).
        
        Generates a secure temporary password for the specified user and marks them
        as requiring a password change on next login.
        
        Security:
        - Requires JWT authentication
        - Requires Guardian 'update' permission on 'admin_password_reset' resource
        - Multi-tenant isolation enforced (admin and user must be in same company)
        - Temporary password is 12 characters with letters, digits, and special characters
        - Password is shown only once in the response
        
        Process:
        1. Verify user exists
        2. Check multi-tenant isolation (same company)
        3. Generate secure temporary password
        4. Hash and save password
        5. Set password_reset_required = true
        6. Update last_password_change timestamp
        7. Return temporary password (shown only once)
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successful
                  temporary_password:
                    type: string
                    example: aB3$xY9#kL2m
                    description: Temporary password (shown only once)
                  password_reset_required:
                    type: boolean
                    example: true
                  note:
                    type: string
                    example: User must change password on next login. This is the only time the temporary password will be shown.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - either missing Guardian permission or user in different company
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Cannot reset password for user in different company
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User not found
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/me/change-password:
    patch:
      tags: [Users]
      summary: User changes own password
      description: |
        User-initiated password change.
        
        Allows authenticated users to change their own password.
        Required after admin-initiated password reset.
        
        Security:
        - Requires JWT authentication
        - Requires current password verification
        - New password must be at least 8 characters
        
        Process:
        1. Verify current password matches
        2. Validate new password length
        3. Hash and save new password
        4. Clear password_reset_required flag
        5. Update last_password_change timestamp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - current_password
                - new_password
              properties:
                current_password:
                  type: string
                  description: Current password for verification
                  example: OldPassword123
                new_password:
                  type: string
                  minLength: 8
                  description: New password (minimum 8 characters)
                  example: NewSecurePassword456
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password changed successfully
                  password_reset_required:
                    type: boolean
                    example: false
        '400':
          description: Bad request - invalid input or password too short
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Current password is incorrect
                    description: Error message (varies based on validation error)
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User not found
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/password-reset/request:
    post:
      tags: [Users]
      summary: Request password reset (Phase 2)
      security: []
      description: |
        Email-based self-service password reset request (Issue #12 Phase 2).
        
        Initiates a password reset by sending a 6-digit OTP code to the user's email.
        Always returns 200 OK to prevent email enumeration attacks.
        
        Security Features:
        - Rate limiting: 50 requests/hour, 200/day per IP
        - No authentication required (public endpoint)
        - Never reveals if email exists (always 200 OK)
        - OTP expires in 15 minutes (configurable)
        - Maximum 3 verification attempts per OTP
        - Previous OTPs invalidated on new request
        - All requests logged with IP address
        
        Email Service:
        - Requires USE_EMAIL_SERVICE=true in configuration
        - Sends HTML + plain text email with OTP code
        - Email includes user's name and 15-minute expiration notice
        
        Process:
        1. Validate email format
        2. Check if user exists (never revealed in response)
        3. Invalidate any previous OTPs for user
        4. Generate 6-digit numeric OTP
        5. Hash and store OTP with 15-minute expiration
        6. Send OTP via email
        7. Return generic success message (always 200)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: Email address of the account to reset
                  example: user@example.com
      responses:
        '200':
          description: Request processed (generic message to prevent email enumeration)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If an account with this email exists, a password reset code has been sent.
        '400':
          description: Bad request - invalid email format
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Invalid email format
        '429':
          description: Too many requests - rate limit exceeded
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Too many requests. Please try again later.
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/password-reset/confirm:
    post:
      tags: [Users]
      summary: Confirm password reset with OTP (Phase 2)
      security: []
      description: |
        Completes password reset using OTP code from email (Issue #12 Phase 2).
        
        Verifies the OTP code and sets a new password for the user account.
        
        Security Features:
        - Rate limiting: 50 requests/hour, 200/day per IP
        - No authentication required (public endpoint)
        - OTP must be valid, not expired, and not used
        - Maximum 3 verification attempts per OTP
        - Failed attempts increment counter
        - Email case-insensitive matching
        - New password must be at least 8 characters
        - All requests logged with IP address
        
        Process:
        1. Validate input (email, OTP, new password)
        2. Find user by email (case-insensitive)
        3. Retrieve valid OTP for user
        4. Check OTP not expired (15 minutes)
        5. Check attempts < 3
        6. Verify OTP code matches hash
        7. Hash and save new password
        8. Mark OTP as used
        9. Clear password_reset_required flag
        10. Update last_password_change timestamp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - otp_code
                - new_password
              properties:
                email:
                  type: string
                  format: email
                  description: Email address of the account
                  example: user@example.com
                otp_code:
                  type: string
                  pattern: '^\d{6}$'
                  description: 6-digit OTP code from email
                  example: "123456"
                new_password:
                  type: string
                  minLength: 8
                  description: New password (minimum 8 characters)
                  example: NewSecurePassword456
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successful
        '400':
          description: Bad request - invalid input or OTP verification failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Invalid or expired OTP code
                    description: Generic error message (invalid OTP, expired, max attempts, password too short, etc.)
        '429':
          description: Too many requests - rate limit exceeded
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Too many requests. Please try again later.
        '500':
          $ref: '#/components/responses/InternalServerError'

  /positions/{position_id}/users:
    parameters:
      - name: position_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the position

    get:
      tags: [Users]
      summary: Get users for a position
      description: Returns the list of users associated with a specific position
      responses:
        '200':
          $ref: '#/components/responses/UserList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /subcontractors:
    get:
      tags: [Subcontractors Management]
      summary: List all subcontractors
      description: Returns the list of all subcontractors with optional filtering, search, pagination, and sorting
      parameters:
        - name: id__in
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated list of UUIDs to filter by. Returns only subcontractors with matching IDs. Empty string returns empty list.
          example: "550e8400-e29b-41d4-a716-446655440000,660e8400-e29b-41d4-a716-446655440001"
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Filter by exact subcontractor name match
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Search in name, email, and contact_person (case-insensitive)
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 50
          description: Number of items per page (max 1000)
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, updated_at, name]
            default: created_at
          description: Field to sort by
        - name: order
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: Sort order (ascending or descending)
      responses:
        '200':
          $ref: '#/components/responses/SubcontractorList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Subcontractors Management]
      summary: Create a new subcontractor
      description: |
        Creates a new subcontractor with the provided data.
        The company_id is automatically extracted from the JWT token and cannot be provided in the request body.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubcontractorCreate'
      responses:
        '201':
          $ref: '#/components/responses/SubcontractorCreated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /subcontractors/{subcontractor_id}:
    parameters:
      - name: subcontractor_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the subcontractor

    get:
      tags: [Subcontractors Management]
      summary: Get a subcontractor by ID
      description: Returns details of a specific subcontractor
      responses:
        '200':
          $ref: '#/components/responses/SubcontractorDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Subcontractors Management]
      summary: Update a subcontractor
      description: Fully updates an existing subcontractor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubcontractorUpdate'
      responses:
        '200':
          $ref: '#/components/responses/SubcontractorUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Subcontractors Management]
      summary: Partially update a subcontractor
      description: Partially updates an existing subcontractor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubcontractorUpdate'
      responses:
        '200':
          $ref: '#/components/responses/SubcontractorUpdated'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Subcontractors Management]
      summary: Delete a subcontractor
      description: Deletes an existing subcontractor
      responses:
        '204':
          $ref: '#/components/responses/SubcontractorDeleted'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /subcontractors/{subcontractor_id}/logo:
    parameters:
      - name: subcontractor_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the subcontractor

    post:
      tags: [Subcontractors Management]
      summary: Upload subcontractor logo
      description: Upload a logo image for the subcontractor. The logo is stored in the Storage Service and a file_id reference is saved.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - logo
              properties:
                logo:
                  type: string
                  format: binary
                  description: Logo image file (PNG, JPG, JPEG)
      responses:
        '201':
          description: Logo uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logo uploaded successfully
                  logo_file_id:
                    type: string
                    example: 550e8400-e29b-41d4-a716-446655440000
                  has_logo:
                    type: boolean
                    example: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Cannot manage other company's subcontractor logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
        '503':
          description: Service Unavailable - Storage Service disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Subcontractors Management]
      summary: Get subcontractor logo
      description: Retrieve the subcontractor logo image from Storage Service
      responses:
        '200':
          description: Logo image
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Subcontractor not found or has no logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Subcontractors Management]
      summary: Delete subcontractor logo
      description: Remove the subcontractor logo from Storage Service and clear the reference
      responses:
        '204':
          description: Logo deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Cannot delete other company's subcontractor logo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Subcontractor not found or has no logo to delete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /verify_password:
    post:
      tags: [Authentification]
      summary: Verify password
      description: Verifies if the provided password matches the user's password. Used by Authentification Service to create tokens.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordVerification'
      responses:
        '200':
          $ref: '#/components/responses/PasswordVerificationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          description: Invalid password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "User or password invalid"
        '500':
          $ref: '#/components/responses/InternalServerError'

tags:
- name: System
  description: System health, version, and configuration endpoints
- name: Users
  description: User management operations
- name: Authentification
  description: Password verification endpoint used by Authentification Service for token creation
- name: Companies
  description: Company management operations
- name: Organizations
  description: Organization management operations
- name: Positions
  description: Position management operations
- name: Customers Management
  description: Customer management operations
- name: Subcontractors Management
  description: Subcontractor management operations
